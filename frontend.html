<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Daily Update</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

    :root {
      --bg-dark: #222831;
      --bg-dark-secondary: #31363F;
      --bg-dark-chart: #393E46;
      --text-dark-primary: #e0e6ff;
      --text-dark-secondary: #a5ade0;
      --shadow-dark: rgba(0, 0, 0, 0.6);
      --shadow-hover-dark: #DDDDDD;

      --bg-light: #FAF6E9;
      --bg-light-secondary: #FFFDF6;
      --bg-light-chart: #ffffff;
      --text-light-primary: #222831;
      --text-light-secondary: #555f7a;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-hover-light: rgba(100, 100, 100, 0.3);
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 1rem;
      box-sizing: border-box;
      background: var(--bg-dark);
      color: var(--text-dark-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.light {
      background: var(--bg-light);
      color: var(--text-light-primary);
    }

    header {
      text-align: center;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 1000px;
    }

    header h1 {
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0;
      letter-spacing: 1px;
      color: inherit;
    }

    header p {
      font-weight: 400;
      font-size: 1rem;
      margin: 0.3rem 0 0;
      color: var(--text-dark-secondary);
      transition: color 0.3s ease;
    }

    body.light header p {
      color: var(--text-light-secondary);
    }

    .chart-container {
      width: 100%;
      max-width: 1100px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 30px var(--shadow-dark);
      background-color: var(--bg-dark-chart);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      height: 575px;
      margin-bottom: 40px; /* Added margin to create space between chart and news */
    }

    .chart-container:hover {
      box-shadow: 0 2px 20px var(--shadow-hover-dark);
    }

    body.light .chart-container {
      background-color: var(--bg-light-chart);
      box-shadow: 0 12px 30px var(--shadow-light);
    }

    body.light .chart-container:hover {
      box-shadow: 0 18px 40px var(--shadow-hover-light);
    }

    @media (max-width: 1000px) {
      .chart-container {
        height: 575px;
        max-width: 100vw;
      }

      header h1 {
        font-size: 1.4rem;
      }
    }

    /* Theme switch container - position top right */
    .theme-switch-wrapper {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      display: flex;
      align-items: center;
      user-select: none;
    }

    /* Label text */
    .theme-switch-label {
      margin-right: 0.8rem;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-dark-primary);
      transition: color 0.3s ease;
    }

    body.light .theme-switch-label {
      color: var(--text-light-primary);
    }

    /* The switch - the slider container */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    /* Hide default checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #444444;
      transition: 0.4s;
      border-radius: 34px;
    }

    /* The circle with icon */
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #f39c12;
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
      mask-size: contain;
      mask-repeat: no-repeat;
      mask-position: center;
      mask-image: url('data:image/svg+xml;utf8,<svg fill="%23f1c40f" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>');
    }

    /* Checked state */
    input:checked + .slider {
      background-color: #4285f4;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
      color: #f1c40f;
      mask-image: url('data:image/svg+xml;utf8,<svg fill="none" height="24" stroke="%23f39c12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"/><line x1="12" x2="12" y1="1" y2="3"/><line x1="12" x2="12" y1="21" y2="23"/><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"/><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"/><line x1="1" x2="3" y1="12" y2="12"/><line x1="21" x2="23" y1="12" y2="12"/><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"/><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"/></svg>');
    }

    /* Focus styles for accessibility */
    input:focus + .slider {
      box-shadow: 0 0 2px 3px rgba(66, 133, 244, 0.5);
    }

    /* News box styles - Updated to match the overall UI */
    .news-box {
      width: 100%;
      max-width: 1100px; /* Match chart container width */
      border-radius: 12px;
      overflow: hidden;
      padding: 25px;
      box-sizing: border-box;
      background-color: var(--bg-dark-secondary);
      box-shadow: 0 12px 30px var(--shadow-dark);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
      margin-bottom: 40px;
    }
    .news-box:hover {
      box-shadow: 0 2px 20px var(--shadow-hover-dark);
    }

    body.light .news-box {
      background-color: var(--bg-light-secondary);
      box-shadow: 0 12px 30px var(--shadow-light);
    }

    .news-title {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 25px;
      color: #93c5fd;
      border-bottom: 3px solid #fbbf24;
      padding-bottom: 12px;
      transition: color 0.3s ease, border-color 0.3s ease;
    }    

    body.light .news-title {
      color: #2c5282;
      border-color: #4299e1;
    }

    .articles {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .article {
      padding-bottom: 15px;
      border-bottom: 1px solid #475569;
      transition: border-color 0.3s ease;
    }

    body.light .article {
      border-color: #e2e8f0;
    }

    .article:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .article a {
      text-decoration: none;
      color: #fbbf24;
      font-weight: 600;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }

    body.light .article a {
      color: #2b6cb0;
    }

    .article a:hover {
      color: #facc15;
      text-decoration: underline;
    }

    body.light .article a:hover {
      color: #3182ce;
    }

    .article p {
      margin: 8px 0 0;
      color: #cbd5e1;
      font-size: 0.95rem;
      line-height: 1.4;
      transition: color 0.3s ease;
    }

    body.light .article p {
      color: #4a5568;
    }

    button.load-more {
      margin-top: 25px;
      padding: 14px 0;
      border-radius: 25px;
      border: none;
      background: #3182ce;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 8px 15px rgba(49,130,206,0.3);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      width: 150px;
      align-self: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    button.load-more:hover {
      background: #2c7ac9;
      box-shadow: 0 12px 20px rgba(44,122,201,0.4);
    }

    .loading {
      text-align: center;
      color: #a1a1aa;
      font-style: italic;
      margin-top: 18px;
      min-height: 24px;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }

    body.light .loading {
      color: #718096;
    }
  </style>
</head>
<body class="dark">

  <div class="theme-switch-wrapper" role="region" aria-label="Toggle light or dark theme">
    <label class="theme-switch-label" for="theme-switch"></label>
    <label class="switch" aria-label="Toggle light/dark theme">
      <input type="checkbox" id="theme-switch" />
      <span class="slider"></span>
    </label>
  </div>

  <header>
    <h1>Daily Update</h1>
    <p>Stay informed with the latest news updates and interactive charts that bring data to lifeâ€”all in one place.</p>
  </header>

  <div class="chart-container" id="tv_chart_container">
    <div id="tradingview_widget"></div>
  </div>

  <div class="news-box" id="global-news-box">
    <h2 class="news-title">Global Business News</h2>
    <div class="articles" id="global-articles"></div>
    <button class="load-more" id="global-load-btn">Load More</button>
    <div class="loading" id="global-loading" style="display:none;">Loading...</div>
  </div>

  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    const containerId = "tradingview_widget";
    const themeSwitch = document.getElementById('theme-switch');
    let currentTheme = 'dark';
    let widget = null;

    function createWidget(theme) {
      if (widget) {
        document.getElementById(containerId).innerHTML = '';
      }
      widget = new TradingView.widget({
        container_id: containerId,
        width: "100%",
        height: "575",
        symbol: "BINANCE:BTCUSDT",
        interval: "D",
        timezone: "Etc/UTC",
        theme: theme,
        style: "1",
        locale: "en",
        toolbar_bg: theme === 'dark' ? "#0d1130" : "#f5f7fa",
        enable_publishing: false,
        hide_side_toolbar: false,
        allow_symbol_change: true,
        
        // Fixed settings for indicators, calendar, and hotlist
        withdateranges: true,
        show_popup_button: true,
        popup_width: "1000",
        popup_height: "650",
        
        // Explicitly enable these features
        calendar: true,
        hotlist: true,
        details: true,
        
        // Add studies properly with proper spacing
        studies_overrides: {
          "macd.plot.color": "#FF6D00",
          "macd.signal.color": "#2962FF",
          "macd.histogram.color": "#B71C1C",
          "rsi.plot.color": "#9C27B0"
        },
        studies: [
          "MACD@tv-basicstudies",
          "RSI@tv-basicstudies"
        ],
        
        // Add the TradingView studies drawings toolbar
        drawings_access: { type: 'all', tools: [ { name: "Regression Trend" } ] },
        
        // Better layout management
        saved_data: {
          content: {
            charts: [{
              layout: "s",
              charts_colors: true
            }]
          }
        },
        
        // Disable autosize to use fixed height
        autosize: false
      });
    }

    function updateTheme(newTheme) {
      const body = document.body;
      if (newTheme === 'light') {
        body.classList.remove('dark');
        body.classList.add('light');
        themeSwitch.checked = true;
      } else {
        body.classList.remove('light');
        body.classList.add('dark');
        themeSwitch.checked = false;
      }
      createWidget(newTheme);
      currentTheme = newTheme;
      localStorage.setItem('tv-theme', newTheme);
    }

    window.addEventListener('load', () => {
      const savedTheme = localStorage.getItem('tv-theme');
      if (savedTheme === 'light' || savedTheme === 'dark') {
        updateTheme(savedTheme);
      } else {
        updateTheme('dark');
      }
    });

    themeSwitch.addEventListener('change', () => {
      const newTheme = themeSwitch.checked ? 'light' : 'dark';
      updateTheme(newTheme);
    });

    const baseUrl = 'http://localhost:5000';

    const globalArticles = document.getElementById('global-articles');
    const globalLoadBtn = document.getElementById('global-load-btn');
    const globalLoading = document.getElementById('global-loading');

    let globalPage = 1;
    const pageSize = 6;

    async function fetchNews(endpoint, page) {
      try {
        const response = await fetch(`${baseUrl}${endpoint}?page=${page}&page_size=${pageSize}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return await response.json();
      } catch (err) {
        alert('Failed to load news: ' + err.message);
        return null;
      }
    }

    function createArticleEl(article) {
      const div = document.createElement('div');
      div.className = 'article';

      const titleLink = document.createElement('a');
      titleLink.href = article.url || '#';
      titleLink.target = '_blank';
      titleLink.rel = "noopener noreferrer";
      titleLink.textContent = article.title || 'No Title';

      const desc = document.createElement('p');
      desc.textContent = article.description || '';

      div.appendChild(titleLink);
      div.appendChild(desc);
      return div;
    }

    async function loadGlobalNews() {
      globalLoading.style.display = 'block';
      globalLoadBtn.disabled = true;
      const data = await fetchNews('/news/global', globalPage);
      if (data && data.news && data.news.length) {
        data.news.forEach(article => {
          globalArticles.appendChild(createArticleEl(article));
        });
        globalPage++;
        if ((globalPage - 1) * pageSize >= data.total) {
          globalLoadBtn.style.display = 'none';
        }
      } else {
        globalLoadBtn.style.display = 'none';
      }
      globalLoading.style.display = 'none';
      globalLoadBtn.disabled = false;
    }

    globalLoadBtn.addEventListener('click', () => loadGlobalNews());

    // Load initial news when page loads
    window.addEventListener('load', () => {
      loadGlobalNews();
    });
  </script>
</body>
</html>